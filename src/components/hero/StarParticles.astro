---
// Star Particles Component - Twinkling stars in the dark sky
---

<div class="star-particles-container">
  <canvas id="star-canvas"></canvas>
</div>

<style>
  .star-particles-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 60%;
    z-index: 1;
    pointer-events: none;
  }

  #star-canvas {
    width: 100%;
    height: 100%;
    display: block;
  }
</style>

<script>
  import { gsap } from 'gsap';

  // Star Particle Class
  class StarParticle {
    x: number;
    y: number;
    radius: number;
    baseAlpha: number;
    alpha: number;
    twinkleSpeed: number;
    twinklePhase: number;
    color: string;
    brightness: number;

    constructor(canvasWidth: number, canvasHeight: number) {
      // Position stars in top portion of screen (dark space area)
      this.x = Math.random() * canvasWidth;
      this.y = Math.random() * (canvasHeight * 0.6); // Top 60% of screen for more coverage

      // Size - small stars
      this.radius = Math.random() * 1.5 + 0.5;

      // Twinkling properties - slower and gentler
      this.baseAlpha = Math.random() * 0.5 + 0.4;
      this.alpha = this.baseAlpha;
      this.twinkleSpeed = Math.random() * 0.005 + 0.003; // Much slower twinkling
      this.twinklePhase = Math.random() * Math.PI * 2;
      this.brightness = Math.random() * 0.4 + 0.6;

      // Star colors - white to yellow-white
      const colors = [
        '#FFFFFF', // pure white
        '#FFF8DC', // cornsilk
        '#FFFAF0', // floral white
        '#FFFFF0', // ivory
        '#F0F8FF', // alice blue
      ];
      this.color = colors[Math.floor(Math.random() * colors.length)];
    }

    update() {
      // Gentle twinkling effect - slow and smooth pulsing
      this.twinklePhase += this.twinkleSpeed;
      
      // Create gentle twinkling pattern - subtle brightness variation
      const twinkle = Math.sin(this.twinklePhase) * 0.4 + 0.6; // Gentler variation (0.2 to 1.0)
      const slowPulse = Math.sin(this.twinklePhase * 0.5) * 0.2 + 0.8; // Very slow pulse
      
      // Combine twinkling effects - gentle and smooth
      this.alpha = this.baseAlpha * twinkle * slowPulse;
      
      // Occasionally create a gentle bright sparkle (less frequent)
      if (Math.random() < 0.0005) {
        this.alpha = Math.min(1, this.alpha * 1.5);
      }
    }

    draw(ctx: CanvasRenderingContext2D) {
      // Draw star with glow effect
      const gradient = ctx.createRadialGradient(
        this.x, this.y, 0,
        this.x, this.y, this.radius * 3
      );
      gradient.addColorStop(0, `${this.color}${Math.floor(this.alpha * 255).toString(16).padStart(2, '0')}`);
      gradient.addColorStop(0.5, `${this.color}${Math.floor(this.alpha * 0.5 * 255).toString(16).padStart(2, '0')}`);
      gradient.addColorStop(1, 'transparent');

      ctx.fillStyle = gradient;
      ctx.beginPath();
      ctx.arc(this.x, this.y, this.radius * 3, 0, Math.PI * 2);
      ctx.fill();

      // Draw bright core
      ctx.fillStyle = `${this.color}${Math.floor((this.alpha * this.brightness) * 255).toString(16).padStart(2, '0')}`;
      ctx.beginPath();
      ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
      ctx.fill();

      // Add cross-hair sparkle effect for some stars
      if (this.radius > 1) {
        ctx.strokeStyle = `${this.color}${Math.floor((this.alpha * 0.6) * 255).toString(16).padStart(2, '0')}`;
        ctx.lineWidth = 0.5;
        ctx.beginPath();
        ctx.moveTo(this.x - this.radius * 2, this.y);
        ctx.lineTo(this.x + this.radius * 2, this.y);
        ctx.moveTo(this.x, this.y - this.radius * 2);
        ctx.lineTo(this.x, this.y + this.radius * 2);
        ctx.stroke();
      }
    }
  }

  // Initialize star particles
  function initStarParticles() {
    const canvas = document.getElementById('star-canvas') as HTMLCanvasElement;
    if (!canvas) return;

    const ctx = canvas.getContext('2d');
    if (!ctx) return;

    // Set canvas size
    function resizeCanvas() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight * 0.6; // Top 60% for stars
    }
    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);

    // Create stars - more stars for denser midnight sky
    const starCount = window.innerWidth < 768 ? 150 : 200;
    const stars: StarParticle[] = [];

    for (let i = 0; i < starCount; i++) {
      stars.push(new StarParticle(canvas.width, canvas.height));
    }

    // Animation loop using GSAP ticker
    gsap.ticker.add(() => {
      // Clear canvas
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // Update and draw stars
      stars.forEach(star => {
        star.update();
        star.draw(ctx);
      });
    });

    // Add entrance animation
    gsap.from(canvas, {
      opacity: 0,
      duration: 3,
      ease: 'power2.out'
    });
  }

  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initStarParticles);
  } else {
    initStarParticles();
  }

  // Re-initialize on navigation (for Astro View Transitions)
  document.addEventListener('astro:page-load', initStarParticles);
</script>

