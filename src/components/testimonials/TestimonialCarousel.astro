---
interface Testimonial {
  quote: string;
  author: string;
  location: string;
  service?: string;
}

interface Props {
  testimonials?: Testimonial[];
}

const {
  testimonials = [
    {
      quote: "Tony's energy work helped me release years of stored tension. I feel lighter, clearer, and more connected to myself than ever before. The combination of Qi Gong and bodywork was exactly what I needed.",
      author: "Sarah M.",
      location: "Seattle, WA",
      service: "Energy Healing & Bodywork"
    },
    {
      quote: "The herbal remedies from the apothecary have become an essential part of my wellness routine. Natural, effective, and carefully crafted with knowledge and care. Tony takes the time to really understand what you need.",
      author: "Michael L.",
      location: "Portland, OR",
      service: "Herbal Medicine"
    },
    {
      quote: "A truly transformative experience. The combination of massage and energy healing addressed issues I didn't even know I was carrying. Tony's presence and skill create a safe space for deep healing.",
      author: "Jennifer K.",
      location: "Bellingham, WA",
      service: "Therapeutic Bodywork"
    },
    {
      quote: "The kayak meditation sessions changed my relationship with both water and myself. Tony's guidance helped me find stillness even in movement. It's meditation, therapy, and nature connection all at once.",
      author: "David R.",
      location: "Tacoma, WA",
      service: "Movement Arts"
    },
    {
      quote: "I came for physical healing and found so much more. Tony's holistic approach honors the whole person‚Äîbody, mind, and spirit. The Tai Chi practice he taught me continues to benefit me daily.",
      author: "Lisa T.",
      location: "Olympia, WA",
      service: "Qi Gong & Tai Chi"
    }
  ]
} = Astro.props;
---

<section class="testimonial-carousel-section">
  <div class="container">
    <div class="carousel-header fade-in-scroll">
      <h2 class="section-title text-gradient-sunset">Client Experiences</h2>
      <p class="section-subtitle">
        Stories of transformation and healing from the community
      </p>
    </div>

    <div class="carousel-container glass">
      <div class="carousel-wrapper" id="carousel-wrapper">
        {testimonials.map((testimonial, index) => (
          <div
            class="testimonial-slide"
            data-index={index}
            style={index === 0 ? 'display: block;' : 'display: none;'}
          >
            <div class="testimonial-content">
              <div class="quote-icon">üí¨</div>
              <blockquote class="testimonial-quote">
                {testimonial.quote}
              </blockquote>
              <div class="testimonial-author">
                <strong>{testimonial.author}</strong>
                <span class="author-location">{testimonial.location}</span>
                {testimonial.service && (
                  <span class="author-service">{testimonial.service}</span>
                )}
              </div>
            </div>
          </div>
        ))}
      </div>

      <!-- Navigation Controls -->
      <div class="carousel-controls">
        <button
          class="carousel-btn carousel-prev"
          id="carousel-prev"
          aria-label="Previous testimonial"
        >
          ‚Üê
        </button>

        <div class="carousel-indicators" id="carousel-indicators">
          {testimonials.map((_, index) => (
            <button
              class={`indicator-dot ${index === 0 ? 'active' : ''}`}
              data-index={index}
              aria-label={`Go to testimonial ${index + 1}`}
            />
          ))}
        </div>

        <button
          class="carousel-btn carousel-next"
          id="carousel-next"
          aria-label="Next testimonial"
        >
          ‚Üí
        </button>
      </div>
    </div>
  </div>
</section>

<style>
  .testimonial-carousel-section {
    padding: var(--space-32) 0;
    position: relative;
  }

  /* Header */
  .carousel-header {
    text-align: center;
    margin-bottom: var(--space-12);
  }

  .section-title {
    font-size: clamp(2rem, 5vw, 3.5rem);
    margin-bottom: var(--space-4);
  }

  .section-subtitle {
    font-size: clamp(1rem, 2vw, 1.25rem);
    color: var(--medium-gray);
    font-style: italic;
  }

  /* Carousel Container */
  .carousel-container {
    max-width: 900px;
    margin: 0 auto;
    padding: var(--space-12);
    border-radius: var(--radius-2xl);
    position: relative;
    min-height: 400px;
  }

  .carousel-wrapper {
    position: relative;
    width: 100%;
  }

  .testimonial-slide {
    width: 100%;
    opacity: 0;
    transition: opacity var(--transition-base);
  }

  .testimonial-slide[style*="display: block"] {
    opacity: 1;
  }

  /* Testimonial Content */
  .testimonial-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    gap: var(--space-6);
  }

  .quote-icon {
    font-size: 3rem;
    filter: drop-shadow(0 0 10px rgba(107, 70, 193, 0.5));
  }

  .testimonial-quote {
    font-size: clamp(1.125rem, 2vw, 1.5rem);
    line-height: var(--line-height-relaxed);
    color: var(--off-white);
    font-style: italic;
    margin: 0;
    border: none;
    background: none;
    padding: 0;
  }

  .testimonial-author {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
    align-items: center;
  }

  .testimonial-author strong {
    font-size: var(--text-xl);
    color: var(--sunset-gold);
    font-weight: var(--font-weight-bold);
  }

  .author-location {
    font-size: var(--text-sm);
    color: var(--medium-gray);
  }

  .author-service {
    font-size: var(--text-sm);
    color: var(--dusk-lavender);
    font-style: italic;
  }

  /* Controls */
  .carousel-controls {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-6);
    margin-top: var(--space-8);
  }

  .carousel-btn {
    width: 50px;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(107, 70, 193, 0.3);
    border: 2px solid var(--mystic-purple);
    border-radius: 50%;
    color: var(--white);
    font-size: var(--text-2xl);
    cursor: pointer;
    transition: all var(--transition-base);
  }

  .carousel-btn:hover {
    background: var(--mystic-purple);
    transform: scale(1.1);
    box-shadow: var(--shadow-glow-purple);
  }

  .carousel-btn:active {
    transform: scale(0.95);
  }

  /* Indicators */
  .carousel-indicators {
    display: flex;
    gap: var(--space-3);
    align-items: center;
  }

  .indicator-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: rgba(107, 70, 193, 0.3);
    border: 2px solid var(--mystic-purple);
    cursor: pointer;
    transition: all var(--transition-base);
    padding: 0;
  }

  .indicator-dot:hover {
    background: rgba(107, 70, 193, 0.5);
    transform: scale(1.2);
  }

  .indicator-dot.active {
    background: var(--sunset-gold);
    border-color: var(--sunset-gold);
    transform: scale(1.3);
  }

  /* Responsive Design */
  @media (max-width: 768px) {
    .testimonial-carousel-section {
      padding: var(--space-20) 0;
    }

    .carousel-container {
      padding: var(--space-8);
      min-height: 450px;
    }

    .carousel-controls {
      gap: var(--space-4);
      margin-top: var(--space-6);
    }

    .carousel-btn {
      width: 40px;
      height: 40px;
      font-size: var(--text-xl);
    }

    .testimonial-quote {
      font-size: var(--text-base);
    }
  }

  /* Accessibility */
  @media (prefers-reduced-motion: reduce) {
    .testimonial-slide,
    .carousel-btn,
    .indicator-dot {
      transition: none;
    }
  }
</style>

<script>
  import { gsap } from 'gsap';

  function initTestimonialCarousel() {
    const wrapper = document.getElementById('carousel-wrapper');
    const prevBtn = document.getElementById('carousel-prev');
    const nextBtn = document.getElementById('carousel-next');
    const indicators = document.getElementById('carousel-indicators');

    if (!wrapper || !prevBtn || !nextBtn || !indicators) return;

    const slides = Array.from(wrapper.querySelectorAll('.testimonial-slide'));
    const indicatorDots = Array.from(indicators.querySelectorAll('.indicator-dot'));
    let currentIndex = 0;
    let isAnimating = false;

    // Auto-play settings
    let autoPlayInterval: number;
    const autoPlayDelay = 7000; // 7 seconds

    function showSlide(index: number, direction: 'next' | 'prev' = 'next') {
      if (isAnimating || index === currentIndex) return;
      isAnimating = true;

      const currentSlide = slides[currentIndex];
      const nextSlide = slides[index];

      // Update indicators
      indicatorDots[currentIndex].classList.remove('active');
      indicatorDots[index].classList.add('active');

      // Animate transition with GSAP
      const timeline = gsap.timeline({
        onComplete: () => {
          currentIndex = index;
          isAnimating = false;
        }
      });

      // Fade out current slide
      timeline.to(currentSlide, {
        opacity: 0,
        x: direction === 'next' ? -30 : 30,
        duration: 0.4,
        ease: 'power2.in',
        onComplete: () => {
          currentSlide.style.display = 'none';
          gsap.set(currentSlide, { x: 0 });
        }
      });

      // Fade in next slide
      timeline.set(nextSlide, {
        display: 'block',
        x: direction === 'next' ? 30 : -30,
        opacity: 0
      });

      timeline.to(nextSlide, {
        opacity: 1,
        x: 0,
        duration: 0.5,
        ease: 'power2.out'
      });
    }

    function nextSlide() {
      const nextIndex = (currentIndex + 1) % slides.length;
      showSlide(nextIndex, 'next');
      resetAutoPlay();
    }

    function prevSlide() {
      const prevIndex = (currentIndex - 1 + slides.length) % slides.length;
      showSlide(prevIndex, 'prev');
      resetAutoPlay();
    }

    function startAutoPlay() {
      autoPlayInterval = window.setInterval(nextSlide, autoPlayDelay);
    }

    function stopAutoPlay() {
      if (autoPlayInterval) {
        clearInterval(autoPlayInterval);
      }
    }

    function resetAutoPlay() {
      stopAutoPlay();
      startAutoPlay();
    }

    // Event listeners
    nextBtn.addEventListener('click', nextSlide);
    prevBtn.addEventListener('click', prevSlide);

    // Indicator click handlers
    indicatorDots.forEach((dot, index) => {
      dot.addEventListener('click', () => {
        if (index !== currentIndex) {
          const direction = index > currentIndex ? 'next' : 'prev';
          showSlide(index, direction);
          resetAutoPlay();
        }
      });
    });

    // Keyboard navigation
    document.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowLeft') {
        prevSlide();
      } else if (e.key === 'ArrowRight') {
        nextSlide();
      }
    });

    // Pause on hover
    wrapper.addEventListener('mouseenter', stopAutoPlay);
    wrapper.addEventListener('mouseleave', startAutoPlay);

    // Start auto-play
    startAutoPlay();

    // Cleanup on navigation
    const cleanup = () => {
      stopAutoPlay();
    };

    window.addEventListener('beforeunload', cleanup);
    document.addEventListener('astro:before-preparation', cleanup);
  }

  // Initialize carousel
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initTestimonialCarousel);
  } else {
    initTestimonialCarousel();
  }

  // Re-initialize on navigation
  document.addEventListener('astro:page-load', initTestimonialCarousel);
</script>
